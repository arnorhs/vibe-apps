<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home Network Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family/Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Inter', sans-serif;
        overscroll-behavior: none;
      }
      #canvas {
        cursor: grab;
      }
      #canvas.draw-mode {
        cursor: crosshair;
      }
      #canvas:active {
        cursor: grabbing;
      }
      #svg-canvas {
        z-index: 20;
      }
      .device {
        position: absolute;
        cursor: grab;
        user-select: none;
        min-width: 180px;
        z-index: 10;
      }
      .device:active {
        cursor: grabbing;
        z-index: 11;
      }
      .port {
        cursor: crosshair;
        transition: all 0.2s ease-in-out;
      }
      .port:hover {
        transform: scale(1.2);
        box-shadow: 0 0 10px rgba(96, 165, 250, 0.7); /* blue-400 */
      }
      .port.sfp {
        border-color: #f59e0b; /* amber-500 */
      }
      .port.sfp:hover {
        box-shadow: 0 0 10px rgba(245, 158, 11, 0.7);
      }
      .cable {
        stroke-width: 6;
        stroke: #4b5563; /* gray-600 */
        fill: none;
        pointer-events: none;
        transition: stroke 0.2s;
      }
      .cable.active-draw {
        stroke: #60a5fa; /* blue-400 */
      }
      .guide-line {
        stroke-width: 2;
        stroke: #f59e0b; /* amber-500 */
        stroke-dasharray: 5, 5;
        cursor: move;
        pointer-events: all;
      }
      .guide-line-handle {
        fill: #f59e0b;
        stroke: #fff;
        stroke-width: 2;
        cursor: ew-resize; /* Placeholder, will be set dynamically */
      }
      .text-label {
        position: absolute;
        cursor: grab;
        padding: 4px 8px;
        border-radius: 4px;
        z-index: 15;
        white-space: pre;
      }
      .text-label:focus {
        outline: 2px solid #60a5fa;
        cursor: text;
        background-color: rgba(0, 0, 0, 0.2);
      }
      .active-tool {
        background-color: #3b82f6 !important;
        color: white !important;
      }
    </style>
  </head>
  <body class="bg-gray-800 text-white overflow-hidden antialiased">
    <!-- Canvas -->
    <div id="canvas" class="w-full h-screen relative overflow-hidden">
      <svg id="svg-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none">
        <g id="svg-world">
          <!-- Cables and Lines will be drawn here -->
        </g>
      </svg>
      <div id="world" class="absolute top-0 left-0">
        <!-- Devices and Text will be added here -->
      </div>
    </div>

    <!-- Toolbar -->
    <div
      class="absolute top-4 left-1/2 -translate-x-1/2 bg-gray-900/80 backdrop-blur-sm border border-gray-700 rounded-xl shadow-2xl p-2 flex items-center space-x-2 z-50"
    >
      <!-- Search -->
      <div class="relative">
        <input
          type="text"
          id="search-box"
          placeholder="Search for devices..."
          class="bg-gray-800 border border-gray-600 rounded-lg w-52 py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
          autocomplete="off"
        />
        <div
          id="search-results"
          class="absolute top-full mt-2 left-0 w-full bg-gray-800 border border-gray-600 rounded-lg shadow-xl overflow-hidden hidden"
        ></div>
      </div>
      <!-- Tools -->
      <button
        id="add-device-btn"
        title="Add Custom Device"
        class="bg-gray-700 hover:bg-gray-600 text-gray-300 p-2 rounded-lg transition-colors"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
            clip-rule="evenodd"
          />
        </svg>
      </button>
      <div class="w-px h-8 bg-gray-600"></div>
      <button
        id="line-tool-btn"
        title="Draw Line"
        class="tool-btn bg-gray-700 hover:bg-gray-600 text-gray-300 p-2 rounded-lg transition-colors"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M17.657 18.657L6.343 7.343m11.314 0l-11.314 11.314"
          />
        </svg>
      </button>
      <button
        id="text-tool-btn"
        title="Add Text"
        class="tool-btn bg-gray-700 hover:bg-gray-600 text-gray-300 p-2 rounded-lg transition-colors"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M4 7v10m16-10v10M6 7h2m4 0h2m4 0h2M6 17h12"
          />
        </svg>
      </button>
      <div class="w-px h-8 bg-gray-600"></div>
      <button
        id="reset-btn"
        title="Start Over"
        class="bg-red-600 hover:bg-red-700 p-2 rounded-lg transition-colors"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
          />
        </svg>
      </button>
    </div>

    <!-- Custom Device Modal -->
    <div
      id="device-modal"
      class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] hidden"
    >
      <div class="bg-gray-800 border border-gray-600 rounded-xl shadow-2xl p-6 w-full max-w-md">
        <h2 class="text-xl font-bold mb-4">Create Custom Device</h2>
        <form id="device-form">
          <div class="mb-4">
            <label for="device-name" class="block mb-2">Device Name</label>
            <input
              type="text"
              id="device-name"
              class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3"
              required
            />
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label for="lan-ports" class="block mb-2">LAN Ports</label>
              <input
                type="number"
                id="lan-ports"
                value="4"
                min="0"
                class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3"
              />
            </div>
            <div>
              <label for="sfp-ports" class="block mb-2">SFP+ Ports</label>
              <input
                type="number"
                id="sfp-ports"
                value="0"
                min="0"
                class="bg-gray-700 border border-gray-600 rounded-lg w-full py-2 px-3"
              />
            </div>
          </div>
          <div class="flex justify-end space-x-3">
            <button
              type="button"
              id="cancel-device-btn"
              class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded-lg"
            >
              Cancel
            </button>
            <button type="submit" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg">
              Create
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Element Refs
        const canvas = document.getElementById('canvas')
        const world = document.getElementById('world')
        const svgCanvas = document.getElementById('svg-canvas')
        const svgWorld = document.getElementById('svg-world')
        const searchBox = document.getElementById('search-box')
        const searchResultsContainer = document.getElementById('search-results')
        const resetButton = document.getElementById('reset-btn')
        const addDeviceBtn = document.getElementById('add-device-btn')
        const deviceModal = document.getElementById('device-modal')
        const deviceForm = document.getElementById('device-form')
        const cancelDeviceBtn = document.getElementById('cancel-device-btn')
        const lineToolBtn = document.getElementById('line-tool-btn')
        const textToolBtn = document.getElementById('text-tool-btn')
        const toolBtns = document.querySelectorAll('.tool-btn')

        // --- DATA ---
        let deviceDatabase = [
          {
            id: 'ugw',
            name: 'Unify Cloud Gateway Fiber',
            ports: [
              { type: 'LAN', count: 5 },
              { type: 'SFP+', count: 2, class: 'sfp' },
            ],
          },
          { id: 'zyx', name: 'Zyxel 5-Port 2.5GbE Switch', ports: [{ type: 'LAN', count: 5 }] },
          { id: 'gen', name: 'Generic 5-Port 1Gb Switch', ports: [{ type: 'LAN', count: 5 }] },
          { id: 'uap', name: 'Unify Access Point', ports: [{ type: 'LAN', count: 1 }] },
          { id: 'srv', name: 'Server / Computer', ports: [{ type: 'LAN', count: 1 }] },
          { id: 'isp', name: 'ISP Gateway', ports: [{ type: 'LAN', count: 2 }] },
        ]

        // --- STATE ---
        let devicesOnCanvas = []
        let connections = []
        let isDrawingCable = false
        let currentDrawingCable = null
        let startPort = null
        let deviceIdCounter = 0
        let isPanning = false
        let panX = 0,
          panY = 0
        let lastMouseX = 0,
          lastMouseY = 0
        let activeTool = 'select' // 'select', 'line', 'text'
        let isDrawingLine = false
        let currentLine = null
        let textIdCounter = 0

        // --- UTILITY FUNCTIONS ---
        const getElementCenter = (el) => {
          const rect = el.getBoundingClientRect()
          return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 }
        }

        const createCablePath = (x1, y1, x2, y2) => {
          const dx = x2 - x1
          const dy = y2 - y1
          const sag = Math.sqrt(dx * dx + dy * dy) * 0.25
          return `M ${x1} ${y1} C ${x1 + dx * 0.25} ${y1 + dy * 0.25 + sag}, ${x1 + dx * 0.75} ${y1 + dy * 0.75 + sag}, ${x2} ${y2}`
        }

        // --- CORE LOGIC ---

        function setActiveTool(tool) {
          // Deselect other tools
          toolBtns.forEach((btn) => btn.classList.remove('active-tool'))

          if (activeTool === tool) {
            activeTool = 'select'
            canvas.classList.remove('draw-mode')
          } else {
            activeTool = tool
            const activeBtn = document.getElementById(`${tool}-tool-btn`)
            if (activeBtn) activeBtn.classList.add('active-tool')

            if (tool === 'line' || tool === 'text') {
              canvas.classList.add('draw-mode')
            } else {
              canvas.classList.remove('draw-mode')
            }
          }
        }

        // Device Management
        const addDeviceToCanvas = (deviceInfo) => {
          deviceIdCounter++
          const deviceElement = document.createElement('div')
          const deviceId = `device-${deviceIdCounter}`
          deviceElement.id = deviceId
          deviceElement.className =
            'device bg-gray-700 rounded-lg shadow-lg border border-gray-600 p-3'
          deviceElement.style.left = `${window.innerWidth / 2 - 90 - panX}px`
          deviceElement.style.top = `${window.innerHeight / 2 - 40 - panY}px`

          let portCounter = 0
          let portsHTML = (deviceInfo.ports || [])
            .map((portGroup) => {
              let groupHTML = ''
              for (let i = 0; i < portGroup.count; i++) {
                portCounter++
                groupHTML += `<div class="port w-5 h-5 bg-gray-900 border-2 border-gray-500 rounded-sm ${portGroup.class || ''}" data-device-id="${deviceId}" data-port-id="${portCounter}" title="${portGroup.type} Port ${portCounter}"></div>`
              }
              return groupHTML
            })
            .join('')

          deviceElement.innerHTML = `
                    <div class="font-bold text-center mb-3 text-blue-300 pointer-events-none">${deviceInfo.name}</div>
                    <div class="flex flex-wrap justify-center gap-2">${portsHTML}</div>
                `

          world.appendChild(deviceElement)
          devicesOnCanvas.push({ id: deviceId, element: deviceElement, connections: [] })
          makeDraggable(deviceElement)

          deviceElement.querySelectorAll('.port').forEach((port) => {
            port.addEventListener('mousedown', onPortMouseDown)
            port.addEventListener('mouseup', onPortMouseUp)
          })
        }

        // Dragging Logic
        const makeDraggable = (element) => {
          let pos1 = 0,
            pos2 = 0,
            pos3 = 0,
            pos4 = 0
          const dragMouseDown = (e) => {
            if (e.target.classList.contains('port') || e.target.isContentEditable) return
            e.preventDefault()
            pos3 = e.clientX
            pos4 = e.clientY
            document.onmouseup = closeDragElement
            document.onmousemove = elementDrag
          }

          const elementDrag = (e) => {
            e.preventDefault()
            pos1 = pos3 - e.clientX
            pos2 = pos4 - e.clientY
            pos3 = e.clientX
            pos4 = e.clientY
            element.style.top = element.offsetTop - pos2 + 'px'
            element.style.left = element.offsetLeft - pos1 + 'px'
            if (element.classList.contains('device')) {
              updateCablesForDevice(element.id)
            }
          }

          const closeDragElement = () => {
            document.onmouseup = null
            document.onmousemove = null
          }
          element.onmousedown = dragMouseDown
        }

        // Cable Drawing
        const updateCablesForDevice = (deviceId) => {
          connections.forEach((conn) => {
            if (conn.start.deviceId === deviceId || conn.end.deviceId === deviceId) {
              const startEl = document.querySelector(
                `[data-device-id="${conn.start.deviceId}"][data-port-id="${conn.start.portId}"]`,
              )
              const endEl = document.querySelector(
                `[data-device-id="${conn.end.deviceId}"][data-port-id="${conn.end.portId}"]`,
              )
              if (startEl && endEl) {
                const startPos = getElementCenter(startEl)
                const endPos = getElementCenter(endEl)
                conn.cable.setAttribute(
                  'd',
                  createCablePath(
                    startPos.x - panX,
                    startPos.y - panY,
                    endPos.x - panX,
                    endPos.y - panY,
                  ),
                )
              }
            }
          })
        }

        // --- EVENT LISTENERS ---

        // Tools
        lineToolBtn.addEventListener('click', () => setActiveTool('line'))
        textToolBtn.addEventListener('click', () => setActiveTool('text'))

        // Custom Device Modal
        addDeviceBtn.addEventListener('click', () => deviceModal.classList.remove('hidden'))
        cancelDeviceBtn.addEventListener('click', () => deviceModal.classList.add('hidden'))
        deviceForm.addEventListener('submit', (e) => {
          e.preventDefault()
          const name = document.getElementById('device-name').value
          const lanCount = parseInt(document.getElementById('lan-ports').value) || 0
          const sfpCount = parseInt(document.getElementById('sfp-ports').value) || 0

          const newDevice = {
            id: `custom-${Date.now()}`,
            name: name,
            ports: [],
          }
          if (lanCount > 0) newDevice.ports.push({ type: 'LAN', count: lanCount })
          if (sfpCount > 0) newDevice.ports.push({ type: 'SFP+', count: sfpCount, class: 'sfp' })

          deviceDatabase.push(newDevice)
          addDeviceToCanvas(newDevice)
          deviceModal.classList.add('hidden')
          deviceForm.reset()
        })

        // Search
        searchBox.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase()
          if (!searchTerm) {
            searchResultsContainer.classList.add('hidden')
            return
          }
          const results = deviceDatabase.filter((d) => d.name.toLowerCase().includes(searchTerm))
          searchResultsContainer.innerHTML = results
            .map(
              (d) =>
                `<div class="p-2 hover:bg-blue-600 cursor-pointer" data-device-id="${d.id}">${d.name}</div>`,
            )
            .join('')
          searchResultsContainer.classList.remove('hidden')
        })

        searchResultsContainer.addEventListener('click', (e) => {
          if (e.target.dataset.deviceId) {
            const deviceInfo = deviceDatabase.find((d) => d.id === e.target.dataset.deviceId)
            if (deviceInfo) addDeviceToCanvas(deviceInfo)
            searchBox.value = ''
            searchResultsContainer.classList.add('hidden')
          }
        })

        document.addEventListener('click', (e) => {
          if (!searchBox.contains(e.target)) searchResultsContainer.classList.add('hidden')
        })

        // Reset
        resetButton.addEventListener('click', () => {
          world.innerHTML = ''
          svgWorld.innerHTML = ''
          devicesOnCanvas = []
          connections = []
          panX = 0
          panY = 0
          world.style.transform = `translate(0px, 0px)`
          svgWorld.setAttribute('transform', `translate(0 0)`)
          setActiveTool('select')
        })

        // Cable Drawing Events
        function onPortMouseDown(e) {
          /* ... same as before ... */
        }
        function onPortMouseUp(e) {
          /* ... same as before ... */
        }

        // Main Canvas Mouse Events (Panning, Drawing, Text)
        canvas.addEventListener('mousedown', (e) => {
          if (e.target.closest('.device, .text-label, .guide-line, .guide-line-handle')) return

          if (activeTool === 'select') {
            isPanning = true
            lastMouseX = e.clientX
            lastMouseY = e.clientY
          } else if (activeTool === 'line') {
            isDrawingLine = true
            const startX = e.clientX - panX
            const startY = e.clientY - panY
            currentLine = document.createElementNS('http://www.w3.org/2000/svg', 'line')
            currentLine.setAttribute('class', 'guide-line')
            currentLine.setAttribute('x1', startX)
            currentLine.setAttribute('y1', startY)
            currentLine.setAttribute('x2', startX)
            currentLine.setAttribute('y2', startY)
            svgWorld.appendChild(currentLine)
          } else if (activeTool === 'text') {
            textIdCounter++
            const textEl = document.createElement('div')
            textEl.id = `text-${textIdCounter}`
            textEl.className = 'text-label'
            textEl.style.left = `${e.clientX - panX}px`
            textEl.style.top = `${e.clientY - panY}px`
            textEl.textContent = 'Edit me'
            textEl.contentEditable = true
            world.appendChild(textEl)
            makeDraggable(textEl)
            textEl.focus()
            textEl.addEventListener('dblclick', () => (textEl.contentEditable = true))
            textEl.addEventListener('blur', () => (textEl.contentEditable = false))
            setActiveTool('select') // Revert to select tool after adding text
          }
        })

        window.addEventListener('mousemove', (e) => {
          if (isPanning) {
            const dx = e.clientX - lastMouseX
            const dy = e.clientY - lastMouseY
            lastMouseX = e.clientX
            lastMouseY = e.clientY
            panX += dx
            panY += dy
            world.style.transform = `translate(${panX}px, ${panY}px)`
            svgWorld.setAttribute('transform', `translate(${panX} ${panY})`)
          }

          if (isDrawingCable && startPort && currentDrawingCable) {
            const startPos = getElementCenter(startPort)
            const mousePos = { x: e.clientX, y: e.clientY }
            currentDrawingCable.setAttribute(
              'd',
              createCablePath(
                startPos.x - panX,
                startPos.y - panY,
                mousePos.x - panX,
                mousePos.y - panY,
              ),
            )
          }

          if (isDrawingLine && currentLine) {
            currentLine.setAttribute('x2', e.clientX - panX)
            currentLine.setAttribute('y2', e.clientY - panY)
          }
        })

        window.addEventListener('mouseup', (e) => {
          isPanning = false
          isDrawingLine = false
          currentLine = null

          if (isDrawingCable && currentDrawingCable) {
            currentDrawingCable.remove()
          }
          isDrawingCable = false
          startPort = null
          currentDrawingCable = null
        })

        // --- Re-pasting Cable Functions to ensure they are defined before use ---
        function onPortMouseDown(e) {
          e.stopPropagation()
          isDrawingCable = true
          startPort = e.target
          const startPos = getElementCenter(startPort)
          currentDrawingCable = document.createElementNS('http://www.w3.org/2000/svg', 'path')
          currentDrawingCable.setAttribute('class', 'cable active-draw')
          currentDrawingCable.setAttribute(
            'd',
            `M ${startPos.x - panX} ${startPos.y - panY} L ${startPos.x - panX} ${startPos.y - panY}`,
          )
          svgWorld.appendChild(currentDrawingCable)
        }

        function onPortMouseUp(e) {
          if (isDrawingCable && startPort && startPort !== e.target) {
            const endPort = e.target
            const newConnection = {
              start: { deviceId: startPort.dataset.deviceId, portId: startPort.dataset.portId },
              end: { deviceId: endPort.dataset.deviceId, portId: endPort.dataset.portId },
              cable: currentDrawingCable,
            }
            connections.push(newConnection)
            currentDrawingCable.classList.remove('active-draw')
            updateCablesForDevice(newConnection.start.deviceId)
          }
          // Reset drawing state regardless
          isDrawingCable = false
          startPort = null
          currentDrawingCable = null
        }
      })
    </script>
  </body>
</html>
